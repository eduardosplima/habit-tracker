<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker Pro - Navegação Temporal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: 320px repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
        }

        .habit-cell {
            background-color: white;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 52px;
        }

        .habit-name-cell {
            justify-content: flex-start;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #334155;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            user-select: none;
        }

        .checkbox-custom.checked { background-color: #10b981; border-color: #10b981; color: white; }
        .checkbox-custom.indifferent { background-color: #94a3b8; border-color: #94a3b8; color: white; }
        .checkbox-custom.missed { background-color: #fee2e2; border-color: #ef4444; color: #ef4444; }

        .progress-bar-container { height: 8px; background-color: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #3b82f6; transition: width 0.4s ease; }

        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 700; }
        
        .action-btn {
            opacity: 0;
            transition: opacity 0.2s;
            padding: 4px;
            border-radius: 4px;
        }
        .habit-name-cell:hover .action-btn { opacity: 1; }
        
        .btn-delete { color: #ef4444; }
        .btn-delete:hover { background-color: #fee2e2; }
        .btn-move { color: #64748b; }
        .btn-move:hover { background-color: #f1f5f9; }

        .category-header {
            grid-column: span 8;
            background-color: #f8fafc;
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .heatmap-month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-cell { aspect-ratio: 1/1; border-radius: 3px; background-color: #e2e8f0; }
        .heatmap-cell.level-1 { background-color: #dcfce7; }
        .heatmap-cell.level-2 { background-color: #86efac; }
        .heatmap-cell.level-3 { background-color: #22c55e; }
        .heatmap-cell.level-4 { background-color: #15803d; }

        .date-picker-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Dashboard Superior -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Habit Tracker Pro</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="date" id="date-selector" onchange="goToSelectedDate(this.value)" class="text-slate-500 text-sm font-medium bg-transparent border-none outline-none cursor-pointer hover:text-blue-600 transition-colors">
                        <span class="text-slate-300">|</span>
                        <p class="text-slate-500 text-sm font-medium" id="current-week-label">Carregando...</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Progresso Semanal</span>
                            <span class="text-xs font-bold text-blue-600" id="total-progress-percent">0%</span>
                        </div>
                        <div class="progress-bar-container"><div id="total-progress-fill" class="progress-fill" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3">
                    <div class="bg-slate-50 p-1.5 rounded-xl border border-slate-100 flex gap-2">
                        <button onclick="changeWeek(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all" title="Semana anterior">←</button>
                        <button onclick="resetToToday()" class="px-4 py-2 text-xs font-bold hover:bg-white hover:shadow-sm rounded-lg transition-all text-slate-700">HOJE</button>
                        <button onclick="changeWeek(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all" title="Próxima semana">→</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Dados e Adição -->
        <div class="flex flex-wrap gap-4 items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex flex-wrap gap-3 items-center">
                <button onclick="openAddModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-all">
                    <span class="text-lg leading-none">+</span> Novo Hábito
                </button>
                <div class="h-6 w-px bg-slate-200 mx-2"></div>
                <button onclick="exportData()" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-slate-700 transition-all flex items-center gap-2">
                    Backup
                </button>
                <label class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-bold hover:bg-slate-50 cursor-pointer transition-all">
                    Restaurar
                    <input type="file" class="hidden" accept=".json" onchange="importData(event)">
                </label>
            </div>
            <div id="statusMessage" class="text-[10px] font-bold text-emerald-600 hidden">Salvo com sucesso!</div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="flex px-6 border-b border-slate-100 overflow-x-auto bg-white sticky top-0 z-10 scrollbar-hide">
                <button onclick="switchTab('diario')" id="tab-diario" class="px-5 py-4 text-sm font-medium tab-active whitespace-nowrap">Diário</button>
                <button onclick="switchTab('comercial')" id="tab-comercial" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Comercial</button>
                <button onclick="switchTab('autocuidado')" id="tab-autocuidado" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Autocuidado</button>
                <button onclick="switchTab('remedios')" id="tab-remedios" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Saúde</button>
                <button onclick="switchTab('semanal')" id="tab-semanal" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Semanal</button>
                <button onclick="switchTab('mensal')" id="tab-mensal" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Mensal</button>
                <button onclick="switchTab('anual')" id="tab-anual" class="px-5 py-4 text-sm font-medium text-slate-500 whitespace-nowrap">Anual</button>
            </div>

            <div id="main-grid-container" class="overflow-x-auto">
                <div class="habit-grid" id="main-grid"></div>
            </div>

            <div id="annual-view" class="p-8 hidden space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-slate-800">Mapa de Calor Anual</h2>
                    <div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-xl border border-slate-200">
                        <button onclick="changeYear(-1)" class="p-1.5 hover:bg-white rounded-lg transition-all">←</button>
                        <span id="heatmap-year-label" class="text-sm font-bold text-slate-700 px-2 min-w-[60px] text-center">2026</span>
                        <button onclick="changeYear(1)" class="p-1.5 hover:bg-white rounded-lg transition-all">→</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="year-heatmap-container"></div>
            </div>
        </div>
    </div>

    <!-- Modal Base -->
    <div id="customModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-sm w-full p-8 shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="modalTitle">Título</h3>
            <p class="text-slate-500 text-sm mb-6" id="modalText">Descrição.</p>
            <div id="modalInputContainer" class="hidden mb-6">
                <input type="text" id="habitInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do hábito...">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-5 py-2.5 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition-all">Cancelar</button>
                <button id="modalConfirmBtn" class="px-5 py-2.5 text-sm font-bold bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        let appState = JSON.parse(localStorage.getItem('habit_pro_state')) || {
            userRecords: {},
            habitConfig: {},
            deletedHistory: {}
        };

        let currentTab = 'diario';
        let currentReferenceDate = new Date(); // Data base para navegação
        let heatmapYear = new Date().getFullYear();
        
        const todayStr = new Date().toISOString().split('T')[0];

        function init() {
            document.getElementById('date-selector').value = currentReferenceDate.toISOString().split('T')[0];
            updateLabels();
            renderGrid();
        }

        function getStartOfWeek(refDate) {
            const date = new Date(refDate);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date.setDate(diff));
            monday.setHours(0,0,0,0);
            return monday;
        }

        function updateLabels() {
            const start = getStartOfWeek(currentReferenceDate);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            const options = { day: '2-digit', month: 'short' };
            document.getElementById('current-week-label').innerText = 
                `${start.toLocaleDateString('pt-BR', options)} — ${end.toLocaleDateString('pt-BR', { ...options, year: 'numeric' })}`;
            
            // Atualiza input se mudou via botões
            document.getElementById('date-selector').value = currentReferenceDate.toISOString().split('T')[0];
        }

        function renderGrid() {
            const grid = document.getElementById('main-grid');
            const annualView = document.getElementById('annual-view');
            const gridContainer = document.getElementById('main-grid-container');
            
            if (currentTab === 'anual') {
                gridContainer.classList.add('hidden');
                annualView.classList.remove('hidden');
                renderHeatmap();
                return;
            }

            gridContainer.classList.remove('hidden');
            annualView.classList.add('hidden');

            const weekdays = ["SEG", "TER", "QUA", "QUI", "SEX", "SÁB", "DOM"];
            let html = `<div class="habit-cell habit-name-cell bg-slate-50 font-bold border-b border-r border-slate-200">Hábito</div>`;
            weekdays.forEach(day => html += `<div class="habit-cell bg-slate-50 font-bold text-[10px] text-slate-400 border-b border-slate-200">${day}</div>`);

            const startOfWeekStr = getStartOfWeek(currentReferenceDate).toISOString().split('T')[0];
            const list = appState.habitConfig[currentTab] || [];
            
            list.forEach((entry, index) => {
                if (typeof entry === 'object' && entry.category) {
                    html += `<div class="category-header"><span>${entry.category}</span></div>`;
                    entry.items.forEach((h, subIdx) => {
                        if (isHabitVisible(h, startOfWeekStr)) {
                            html += renderRow(h, index, subIdx, true);
                        }
                    });
                } else {
                    if (isHabitVisible(entry, startOfWeekStr)) {
                        html += renderRow(entry, index, null, false);
                    }
                }
            });

            grid.innerHTML = html;
            calculateProgress();
        }

        function isHabitVisible(name, startOfWeek) {
            const delDate = appState.deletedHistory[name];
            return !delDate || delDate > startOfWeek;
        }

        function renderRow(habit, index, subIdx, isSubItem) {
            let row = `
                <div class="habit-cell habit-name-cell border-r border-slate-100 group">
                    <button onclick="deleteHabit('${habit}')" class="action-btn btn-delete" title="Remover daqui em diante">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <div class="flex flex-col">
                        <button onclick="moveHabit('${currentTab}', ${index}, ${subIdx}, -1)" class="action-btn btn-move py-0 h-3">▲</button>
                        <button onclick="moveHabit('${currentTab}', ${index}, ${subIdx}, 1)" class="action-btn btn-move py-0 h-3">▼</button>
                    </div>
                    <span class="truncate" title="${habit}">${habit}</span>
                </div>`;

            const start = getStartOfWeek(currentReferenceDate);
            
            let alreadyDoneInPeriod = false;
            if (currentTab === 'semanal' || currentTab === 'autocuidado') {
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    if (appState.userRecords[d.toISOString().split('T')[0]]?.[habit] === 'done') alreadyDoneInPeriod = true;
                }
            } else if (currentTab === 'mensal') {
                const monthYear = start.toISOString().substring(0, 7);
                Object.keys(appState.userRecords).forEach(k => {
                    if (k.startsWith(monthYear) && appState.userRecords[k][habit] === 'done') alreadyDoneInPeriod = true;
                });
            }

            for (let i = 0; i < 7; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                const dStr = date.toISOString().split('T')[0];
                const status = appState.userRecords[dStr]?.[habit] || '';
                const isDeactivated = appState.deletedHistory[habit] && dStr >= appState.deletedHistory[habit];

                let stateClass = '';
                let content = '';

                if (isDeactivated) {
                    stateClass = 'bg-slate-50 opacity-20 cursor-not-allowed';
                } else if (status === 'done') {
                    stateClass = 'checked';
                    content = '✓';
                } else if (status === 'na' || (alreadyDoneInPeriod && status === '')) {
                    stateClass = 'indifferent';
                    content = '-';
                } else if (dStr < todayStr && status === '') {
                    stateClass = 'missed';
                    content = '✕';
                }
                
                row += `
                    <div class="habit-cell border-b border-slate-50">
                        ${isDeactivated ? `<div class="w-6 h-6"></div>` : `
                        <div class="checkbox-custom ${stateClass}" onclick="cycleStatus('${dStr}', '${habit}')">
                             ${content}
                        </div>`}
                    </div>`;
            }
            return row;
        }

        function cycleStatus(date, habit) {
            if (!appState.userRecords[date]) appState.userRecords[date] = {};
            const cur = appState.userRecords[date][habit] || '';
            
            if (cur === '') appState.userRecords[date][habit] = 'done';
            else if (cur === 'done') appState.userRecords[date][habit] = 'na';
            else delete appState.userRecords[date][habit];
            
            save();
            renderGrid();
        }

        // Navegação Temporal
        function goToSelectedDate(val) {
            currentReferenceDate = new Date(val + "T12:00:00");
            updateLabels();
            renderGrid();
        }

        function changeWeek(direction) {
            currentReferenceDate.setDate(currentReferenceDate.getDate() + (direction * 7));
            updateLabels();
            renderGrid();
        }

        function resetToToday() {
            currentReferenceDate = new Date();
            updateLabels();
            renderGrid();
        }

        function changeYear(dir) {
            heatmapYear += dir;
            document.getElementById('heatmap-year-label').innerText = heatmapYear;
            renderHeatmap();
        }

        // CRUD & Gestão
        function openAddModal() {
            document.getElementById('modalInputContainer').classList.remove('hidden');
            document.getElementById('habitInput').value = '';
            showModal("Novo Hábito", `Adicionar em ${currentTab}`, () => {
                const val = document.getElementById('habitInput').value.trim();
                if (val) {
                    if (currentTab === 'autocuidado') {
                        appState.habitConfig[currentTab][0].items.push(val);
                    } else {
                        appState.habitConfig[currentTab].push(val);
                    }
                    save();
                    renderGrid();
                    closeModal();
                }
            });
        }

        function deleteHabit(habit) {
            showModal("Remover?", `"${habit}" será removido das datas futuras.`, () => {
                appState.deletedHistory[habit] = todayStr;
                save();
                renderGrid();
                closeModal();
            });
        }

        function moveHabit(tab, index, subIdx, dir) {
            const list = appState.habitConfig[tab];
            if (subIdx !== null) {
                const items = list[index].items;
                const next = subIdx + dir;
                if (next >= 0 && next < items.length) [items[subIdx], items[next]] = [items[next], items[subIdx]];
            } else {
                const next = index + dir;
                if (next >= 0 && next < list.length) [list[index], list[next]] = [list[next], list[index]];
            }
            save();
            renderGrid();
        }

        function save() { localStorage.setItem('habit_pro_state', JSON.stringify(appState)); }

        function exportData() {
            const data = JSON.stringify(appState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const dl = document.createElement('a');
            dl.href = url;
            dl.download = `habit_tracker_backup_${todayStr}.json`;
            document.body.appendChild(dl);
            dl.click();
            document.body.removeChild(dl);
            URL.revokeObjectURL(url);
            showStatus();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    appState = imported;
                    save();
                    init();
                } catch (err) { alert("Arquivo inválido"); }
            };
            reader.readAsText(file);
        }

        function switchTab(t) {
            document.querySelectorAll('button[id^="tab-"]').forEach(b => b.classList.replace('tab-active', 'text-slate-500'));
            const active = document.getElementById('tab-' + t);
            active.classList.add('tab-active');
            active.classList.remove('text-slate-500');
            currentTab = t;
            renderGrid();
        }

        function showModal(title, text, onConfirm) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalText').innerText = text;
            const btn = document.getElementById('modalConfirmBtn');
            btn.onclick = onConfirm;
            document.getElementById('customModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('customModal').classList.add('hidden');
            document.getElementById('modalInputContainer').classList.add('hidden');
        }

        function showStatus() {
            const msg = document.getElementById('statusMessage');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        function calculateProgress() {
            const start = getStartOfWeek(currentReferenceDate);
            let total = 0, done = 0;
            const itemsToCalc = ['diario', 'comercial', 'remedios', 'semanal', 'autocuidado'];
            
            itemsToCalc.forEach(cat => {
                const list = (cat === 'autocuidado') ? appState.habitConfig[cat].flatMap(c => c.items) : appState.habitConfig[cat];
                list.forEach(h => {
                    const isWeekly = (cat === 'semanal' || cat === 'autocuidado');
                    if (isWeekly) {
                        total++;
                        let found = false;
                        for(let i=0; i<7; i++) {
                            const d = new Date(start); d.setDate(start.getDate()+i);
                            if (appState.userRecords[d.toISOString().split('T')[0]]?.[h] === 'done') found = true;
                        }
                        if (found) done++;
                    } else {
                        for(let i=0; i<7; i++) {
                            const d = new Date(start); d.setDate(start.getDate()+i);
                            const ds = d.toISOString().split('T')[0];
                            if (appState.userRecords[ds]?.[h] !== 'na') {
                                total++;
                                if (appState.userRecords[ds]?.[h] === 'done') done++;
                            }
                        }
                    }
                });
            });

            const perc = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('total-progress-percent').innerText = perc + '%';
            document.getElementById('total-progress-fill').style.width = perc + '%';
        }

        function renderHeatmap() {
            const container = document.getElementById('year-heatmap-container');
            container.innerHTML = '';
            const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            
            months.forEach((name, idx) => {
                const div = document.createElement('div');
                div.className = "bg-slate-50 p-4 rounded-xl border border-slate-100 shadow-sm";
                let html = `<h4 class="font-bold text-slate-700 mb-3">${name}</h4><div class="heatmap-month-grid">`;
                
                const days = new Date(heatmapYear, idx+1, 0).getDate();
                const first = new Date(heatmapYear, idx, 1).getDay();
                
                // Espaços vazios para alinhar os dias da semana
                for(let i=0; i<(first===0?6:first-1); i++) html += `<div></div>`;
                
                for(let d=1; d<=days; d++) {
                    const ds = `${heatmapYear}-${String(idx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    let count = 0; 
                    if(appState.userRecords[ds]) {
                        Object.values(appState.userRecords[ds]).forEach(v => { if(v === 'done') count++; });
                    }
                    
                    let level = '';
                    if (count > 0) {
                        if (count <= 5) level = 'level-1';
                        else if (count <= 15) level = 'level-2';
                        else if (count <= 25) level = 'level-3';
                        else level = 'level-4';
                    }

                    html += `<div class="heatmap-cell ${level}" title="${ds}: ${count} feitos"></div>`;
                }
                div.innerHTML = html + `</div>`;
                container.appendChild(div);
            });
        }

        init();
    </script>
</body>
</html>